<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monad Badge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="index.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Parkinsans:wght@300..800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row" style="height: 100vh;">
            <div class="col-md-3 col-sm-12 bg-blue text-center">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12 my-1">
                            <h4 class="text-white weight-700 text-28 font-park">Log in</h4>
                        </div>
                        <div class="col-12 my-1 text-start">
                            <button id="connectMetamask" class="btn btn-outline-primary bg-light-blue text-black font-park weight-700">
                                Login with Metamask
                            </button>
                        </div>
                        <div class="col-12 my-1 text-start">
                            <p id="walletAddress" class="text-white" style="margin-top: 10px; font-weight: bold;"></p>
                        </div>
                        <div class="col-12 text-start my-1">
                            <span class="text-white weight-700 text-20 font-park mt-3">Community Card Remained</span>
                        </div>
                        <div class="col-12 text-start">
                            <span class="text-white weight-700 text-20 font-park mt-3">1/2000</span>
                        </div>
                        
                    </div>
                </div>
                <hr class="text-white"/>
                <h5 class="text-white weight-700 text-28 font-park mt-3">Uploaded image</h5>
                <img id="uploadedImage" src="#" alt="Uploaded Image" style="display: none;" class="w-100">
            </div>
            <div class="col-md-4 col-sm-12 bg-purple text-center">
                <h4 class="text-white weight-700 text-28 font-park mt-3">Create Card</h4>
                <br>
                <br>
                <div class="container-fluid text-start text-white text-20 font-park">
                    <div class="row">
                        <div class="col-md-3 col-sm-12">Network :</div>
                        <div class="col-md-9 col-sm-12">
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="basic-addon1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-boxes" viewBox="0 0 16 16">
                                        <path d="M7.752.066a.5.5 0 0 1 .496 0l3.75 2.143a.5.5 0 0 1 .252.434v3.995l3.498 2A.5.5 0 0 1 16 9.07v4.286a.5.5 0 0 1-.252.434l-3.75 2.143a.5.5 0 0 1-.496 0l-3.502-2-3.502 2.001a.5.5 0 0 1-.496 0l-3.75-2.143A.5.5 0 0 1 0 13.357V9.071a.5.5 0 0 1 .252-.434L3.75 6.638V2.643a.5.5 0 0 1 .252-.434zM4.25 7.504 1.508 9.071l2.742 1.567 2.742-1.567zM7.5 9.933l-2.75 1.571v3.134l2.75-1.571zm1 3.134 2.75 1.571v-3.134L8.5 9.933zm.508-3.996 2.742 1.567 2.742-1.567-2.742-1.567zm2.242-2.433V3.504L8.5 5.076V8.21zM7.5 8.21V5.076L4.75 3.504v3.134zM5.258 2.643 8 4.21l2.742-1.567L8 1.076zM15 9.933l-2.75 1.571v3.134L15 13.067zM3.75 14.638v-3.134L1 9.933v3.134z"/>
                                      </svg>
                                </span>
                                <input type="text" class="form-control border border-1" placeholder="Monad" aria-describedby="basic-addon1" disabled>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 col-sm-12">Name :</div>
                        <div class="col-md-9 col-sm-12">
                                <input type="text" class="form-control border border-1" value="Community NFT Card Collection # 1" aria-describedby="basic-addon1" disabled>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-6">
                           <!-- <button class="btn btn-primary" onclick="uploadphoto();">Upload photo
                            </button>
                            <input type="file" id="photoUpload" accept="image/*" style="display: none;">-->
                            <label for="photoUpload" class="btn btn-primary">
                                Upload Photo
                                <input type="file" id="photoUpload" accept="image/*" style="display: none;">
                              </label>
                              
                       
                        </div>
                        <div class="col-6">*jpg or png format <br>
                        *max. 150kb</div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <button class="btn btn-danger" id="sendToStorageButton">Send to Storage & Mint</button>
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-12">
                            <div class="col-12"><button class="btn btn-primary" onclick="exportGLB();">Export GLB</button></div>
                            <span id="statusDiv"></span>
                            <div id="ipfsLinkDiv"></div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                        <!-- Display Uploaded Image -->
                        <div id="imagePreview">
                            
                        </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <p id="status"></p>
  <p id="ipfsLink"></p>
                        </div>
                    </div>
                    
                </div>
               

            </div>
            <div class="col-md-5 col-sm-12 ">
                <model-viewer id="reveal" 
                            class="w-100" 
                            loading="eager" 
                            camera-controls 
                            touch-action="pan-y" 
                            auto-rotate 
                            tone-mapping="aces" 
                            src="./models/lightcard.glb" 
                            shadow-intensity="1" 
                            alt="A 3D model of a shishkebab" 
                            style="height: 100vh; max-height: 100vh;">
                </model-viewer>

            </div>
        </div>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</html>



<script>

const modelViewer = document.getElementById("reveal");
let g_material = null;

const uploadedImage = document.getElementById("uploadedImage");
const uploadEndpoint = "https://monadnftcardproject-4155b298a04d.herokuapp.com/upload";

sendToStorageButton.addEventListener("click", async () => {
        if (!photoUpload.files.length) {
            statusDiv.textContent = "Please choose a .glb file to upload!";
            return;
        }

        const file = photoUpload.files[0];
        const formData = new FormData();
        formData.append("file", file);

        statusDiv.textContent = "Uploading to Pinata...";
        ipfsLinkDiv.textContent = "";

        try {
            const response = await fetch(uploadEndpoint, {
                method: "POST",
                body: formData,
            });

            if (!response.ok) {
                throw new Error(`Upload failed: ${response.statusText}`);
            }

            const result = await response.json();
            const ipfsUrl = `https://gateway.pinata.cloud/ipfs/${result.CID}`;

            statusDiv.textContent = "Upload Successful!";
        } catch (error) {
            console.error("Upload Error:", error);
            statusDiv.textContent = "Upload Failed!";
        }
    });

// Model yükleme ve materyal ayarları
modelViewer.addEventListener("load", async () => {
  const model = modelViewer.model;
  const materials = model.materials;

  // Materyal isimlerini kontrol et
  console.log("Available Materials:", materials.map((mat) => mat.name));

  // İlgili materyalleri bul
  g_material = materials.find((mat) => mat.name === "frontside");

  if (!g_material) {
    console.error("Required materials not found. Check your GLB model's material names.");
    return;
  }

  console.log("Materials loaded successfully.");
});

async function exportGLB(){
    const glTF = await modelViewer.exportScene();
    const file = new File([glTF], "export.glb");
    const link = document.createElement("a");
    link.download =file.name;
    link.href = URL.createObjectURL(file);
    link.click();
  }




// Fotoğraf yükleme ve dokuyu güncelleme
const photoUploadInput = document.getElementById("photoUpload");
photoUploadInput.addEventListener("change", async (event) => {
  const file = event.target.files[0];
  if (file && g_material) {
    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const newTexture = await modelViewer.createTexture(e.target.result);
        g_material.pbrMetallicRoughness.baseColorTexture.setTexture(newTexture);
        g_material.pbrMetallicRoughness.roughnessFactor = 1.0; // Tamamen mat (parlaklık yok)
        g_material.pbrMetallicRoughness.metallicFactor = 0.0; // Metalik değil
        console.log("Texture updated successfully.");
        uploadedImage.src = e.target.result;
          uploadedImage.style.display = "block"; 
      } catch (error) {
        console.error("Error setting texture:", error);
      }
    };
    reader.readAsDataURL(file);
  }
});

const connectMetamaskButton = document.getElementById("connectMetamask");
        const walletAddressElement = document.getElementById("walletAddress");

        // MetaMask bağlantısını kuran fonksiyon
        async function connectMetamask() {
            if (typeof window.ethereum !== "undefined") {
                try {
                    // MetaMask'tan hesap isteme
                    const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
                    
                    // İlk hesabı al
                    const account = accounts[0];
                    walletAddressElement.innerText = `Connected Wallet: ${account}`;

                    console.log("Connected Account:", account);
                } catch (error) {
                    console.error("User denied account access or error occurred:", error);
                    walletAddressElement.innerText = "Connection failed!";
                }
            } else {
                alert("MetaMask is not installed. Please install it to connect.");
            }
        }

        // Hesap değişikliklerini dinleme
        window.ethereum.on("accountsChanged", (accounts) => {
            if (accounts.length === 0) {
                walletAddressElement.innerText = "Please connect to MetaMask.";
            } else {
                walletAddressElement.innerText = `Connected Wallet: ${accounts[0]}`;
                console.log("Account changed:", accounts[0]);
            }
        });

        // Ağ değişikliklerini dinleme
        window.ethereum.on("chainChanged", (chainId) => {
            console.log("Network changed to:", chainId);
            window.location.reload();
        });

        // Butona tıklama ile MetaMask bağlama işlemi
        connectMetamaskButton.addEventListener("click", connectMetamask);


  </script>